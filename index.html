<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thread and Nails | Virtual Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }

        .board-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Slightly smaller for mobile verticality */
            aspect-ratio: 1/1;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.7);
            margin: 0 auto;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .control-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .control-btn:active:not(:disabled) {
            transform: scale(0.96);
            filter: brightness(0.8);
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Mobile specific spacing */
        @media (max-width: 768px) {
            .mobile-compact-stats {
                padding: 0.5rem 1rem !important;
            }
            .mobile-grid-fix {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-3 md:p-6">

    <!-- Compact Header & Stats -->
    <div class="w-full max-w-6xl flex flex-col md:flex-row justify-between items-center gap-3 md:gap-6 mb-4 md:mb-8">
        <div class="text-center md:text-left">
            <h1 class="text-2xl md:text-4xl font-bold tracking-tighter uppercase leading-none text-white">
                Thread and Nails
            </h1>
            <p class="text-slate-500 text-[10px] md:text-xs mt-0.5 md:mt-1 uppercase tracking-[0.2em]">Virtual Navigator</p>
        </div>

        <div class="flex w-full md:w-auto gap-1 md:gap-4 glass-panel mobile-compact-stats p-2 md:p-4 rounded-xl md:rounded-2xl justify-around">
            <div class="text-center px-3 md:px-4 border-r border-slate-700">
                <p class="text-[9px] md:text-xs text-slate-500 uppercase font-medium">Progress</p>
                <p id="percentLabel" class="text-base md:text-xl font-bold">0%</p>
            </div>
            <div class="text-center px-3 md:px-4">
                <p class="text-[9px] md:text-xs text-slate-500 uppercase font-medium">Step</p>
                <p id="stepLabel" class="text-base md:text-xl font-bold">0 / 0</p>
            </div>
        </div>
    </div>

    <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-8 items-start">
        
        <!-- Canvas (Priority 1 on Mobile) -->
        <div class="lg:col-span-7 flex justify-center order-1 lg:order-2">
            <div class="board-container">
                <canvas id="bgCanvas"></canvas>
                <canvas id="threadCanvas"></canvas>
                <canvas id="uiCanvas"></canvas>
            </div>
        </div>

        <!-- Controls & Instructions -->
        <div class="lg:col-span-5 flex flex-col gap-4 order-2 lg:order-1 no-select">
            
            <!-- Instruction Card (Targeted visibility on mobile) -->
            <div class="glass-panel p-4 md:p-6 rounded-2xl md:rounded-3xl text-center shadow-xl border-t-2 border-blue-500/30">
                <p class="text-[9px] md:text-xs text-slate-500 uppercase mb-2 md:mb-4 tracking-widest font-bold">Target Nail</p>
                <div class="flex items-center justify-center gap-4 md:gap-8">
                    <div class="opacity-60">
                        <span id="curNailBox" class="text-2xl md:text-5xl font-bold text-slate-400">--</span>
                        <p class="text-[8px] md:text-[10px] mt-1 text-slate-500 uppercase" id="curZoneLabel">From</p>
                    </div>
                    <div class="text-blue-500 text-xl animate-pulse">‚Üí</div>
                    <div class="scale-110 md:scale-100">
                        <span id="nextNailBox" class="text-4xl md:text-6xl font-black text-blue-400">--</span>
                        <p class="text-[9px] md:text-[11px] mt-1 text-blue-300 uppercase font-bold" id="nextZoneLabel">To</p>
                    </div>
                </div>
            </div>

            <!-- Interaction Panel -->
            <div class="glass-panel p-4 md:p-6 rounded-2xl md:rounded-3xl space-y-4">
                <div class="grid grid-cols-2 gap-2 md:gap-3">
                    <button id="prevBtn" class="control-btn bg-slate-700">‚Üê Prev</button>
                    <button id="nextBtn" class="control-btn bg-slate-700">Next ‚Üí</button>
                    <button id="playBtn" class="control-btn bg-blue-600 col-span-2">‚ñ∂ Play Sequence</button>
                    <button id="previewBtn" class="control-btn bg-emerald-600/80 col-span-2">üëÅ Show Finished Art</button>
                </div>

                <div class="flex items-center gap-2">
                    <input type="number" id="jumpInput" placeholder="Move #..." class="flex-1 bg-slate-900 border border-slate-700 rounded-xl py-2 px-4 text-sm focus:outline-none focus:border-blue-500 h-[48px]">
                    <button id="jumpBtn" class="bg-slate-700 hover:bg-slate-600 h-[48px] px-4 rounded-xl text-sm font-bold">Go</button>
                </div>

                <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl">
                    <span class="text-xs md:text-sm font-medium text-slate-300">Voice Guidance</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="voiceToggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PATTERN DATA ARRAY
        const PATTERN_DATA = [0,101,239,102,1,100,0,114,11,113,10,112,9,111,16,120,18,122,218,123,224,128,226,129,227,130,225,127,220,126,23,121,17,119,15,118,14,109,7,108,6,120,19,114,12,116,13,107,5,117,216,53,146,58,148,57,150,64,153,66,156,69,158,73,161,74,160,79,162,72,159,68,157,71,163,78,164,81,165,75,167,80,166,83,168,73,156,64,152,67,160,65,154,63,151,58,147,59,150,66,159,74,157,72,163,82,161,78,158,75,164,70,155,65,162,73,166,81,160,64,149,56,148,66,154,60,146,59,151,68,163,80,159,82,164,74,167,72,168,79,161,81,162,77,165,73,154,67,158,65,148,55,150,69,153,58,144,51,208,44,209,52,212,53,214,54,145,57,147,67,162,83,160,84,165,69,161,64,163,76,166,72,155,74,168,81,158,70,149,60,144,56,151,65,159,84,4,118,21,122,223,126,225,131,228,130,229,133,231,135,230,136,232,138,233,140,234,92,235,108,5,106,12,115,20,122,16,110,8,102,7,119,216,120,24,123,19,125,18,113,0,96,238,98,2,116,4,105,11,89,10,121,217,54,213,52,211,44,210,45,209,87,8,109,15,94,13,93,232,139,49,142,51,145,60,159,79,163,66,164,77,161,80,157,82,160,78,236,94,12,107,234,139,231,134,227,132,229,137,233,95,17,112,239,97,2,103,0,138,230,131,223,121,22,118,8,88,9,119,217,122,224,124,219,125,21,128,220,120,5,115,11,104,232,133,228,86,164,65,165,76,162,68,150,56,147,52,210,46,131,229,134,25,197,29,199,31,201,33,203,43,204,44,206,34,200,30,198,32,205,36,202,28,127,20,100,6,109,13,96,16,118,221,129,43,126,226,132,230,88,7,86,163,75,166,70,150,58,152,74,165,80,158,83,3,117,2,115,215,53,213,45,214,52,143,59,160,77,235,140,58,161,84,158,66,167,71,168,65,146,68,153,57,142,239,139,50,138,229,89,6,119,20,101,238,111,8,85,212,45,208,93,14,95,1,99,237,79,169,74,163,83,2,96,17,113,214,114,3,106,4,86,212,44,207,51,148,15,92,211,45,130,230,134,225,125,222,120,217,53,210,97,12,124,26,196,27,199,34,204,32,202,30,205,44,131,23,123,219,126,42,129,46,135,226,124,10,105,25,122,17,101,22,117,13,108,236,141,234,77,159,64,166,67,163,81,156,68,148,71,169,58,149,66,179,65,150,54,218,124,222,119,2,111,0,140,238,137,231,88,10,104,19,98,239,80,168,85,158,77,163,65,157,63,161,83,156,75,232,103,11,87,210,39,207,33,200,35,199,32,208,94,16,114,1,82,162,80,171,58,165,79,236,107,6,146,8,119,219,111,18,95,11,112,218,121,25,103,23,197,28,200,26,136,235,142,48,139,1,113,215,45,203,44,214,56,166,74,153,67,148,70,146,7,110,15,102,19,128,227,135,224,131,222,116,6,121,221,127,22,104,9,90,5,100,229,136,51,209,95,237,93,235,107,15,97,20,195,19,150,61,161,66,178,65,149,71,164,59,139,233,133,226,123,8,144,62,163,85,160,72,169,57,167,73,148,29,203,35,206,87,162,60,217,45,126,47,210,37,200,24,102,238,82,167,58,163,53,218,125,11,86,157,81,170,56,168,69,181,66,155,80,164,64,151,55,214,115,13,92,14,106,9,113,220,54,216,121,12,99,236,109,1,116,215,52,208,43,202,34,207,87,227,85,157,77,168,64,155,82,3,118,9,93,18,100,23,105,28,198,33,208,30,210,32,203,27,106,13,193,16,149,67,182,68,147,7,120,223,132,231,140,232,96,213,107,14,111,222,128,47,130,221,53,167,84,2,144,0,94,166,87,160,75,233,104,18,101,211,85,1,121,225,136,237,141,5,109,12,93,168,59,158,62,160,70,170,75,162,86,9,110,239,114,219,54,137,228,129,225,124,41,130,19,196,23,97,172,58,215,55,169,76,232,135,25,100,15,194,21,99,227,131,234,133,24,96,236,134,228,72,147,71,170,59,149,28,154,83,159,76,235,97,22,123,222,55,213,87,156,79,158,90,10,114,34,205,43,201,36,117,4,113,238,138,60,165,57,172,80,236,145,59,163,73,146,29,211,32,207,35,201,38,205,31,209,46,204,26,107,22,102,9,116,218,44,125,39,119,0,118,217,123,229,93,16,103,176,64,162,74,171,59,166,85,6,140,4,108,14,195,17,102,211,91,160,89,232,137,51,163,87,7,103,173,58,139,230,101,19,198,31,204,37,207,94,20,99,160,68,180,65,143,239,137,234,76,161,51,166,78,157,67,165,64,144,4,119,238,148,10,111,223,134,224,127,49,206,26,121,45,221,47,138,231,126,25,207,82,156,88,155,30,151,83,9,125,220,52,132,228,85,164,72,184,70,169,66,177,62,221,114,21,197,15,105,174,102,27,210,34,113,2,87,161,65,147,69,151,54,215,44,202,33,116,14,89,5,112,213,46,219,127,42,203,38,209,93,163,99,23,195,12,192,11,123,13,86,8,100,162,61,175,98,177,103,18,150,239,92,165,71,145,49,137,59,172,84,203,31,212,28,206,88,6,147,14,105,2,124,230,73,159,58,174,108,213,56,167,81,153,77,233,141,231,129,223,135,52,217,46,220,122,7,188,9,84,166,91,214,30,197,20,102,163,57,132,58,145,68,181,65,167,51,206,43,116,238,79,172,105,17,191,13,110,218,61,222,45,205,82,166,68,161,95,25,97,178,67,180,106,171,109,239,138,236,75,168,54,223,119,41,115,7,118,1,104,17,92,20,194,9,191,15,106,234,146,72,149,57,166,100,21,204,83,155,68,144,1,120,38,200,36,206,31,211,25,152,86,15,103,19,95,165,101,160,80,156,29,208,27,213,93,23,98,176,105,13,196,11,189,32,209,26,103,165,49,161,52,168,63,178,62,147,237,142,60,223,127,226,122,0,81,206,40,120,238,110,12,87,158,91,178,98,27,195,21,94,6,192,14,104,3,134,237,112,217,44,116,233,135,8,117,34,201,22,193,10,106,175,81,169,73,145,9,87,204,45,131,60,219,53,124,51,118,216,55,170,107,182,66,162,94,26,99,161,71,185,238,75,159,89,155,27,123,225,133,4,115,40,218,105,183,68,149,14,198,18,128,232,143,69,171,72,158,96,208,35,114,235,139,229,129,220,45,223,52,224,137,44,133,56,215,57,174,109,16,102,23,95,239,184,98,17,200,43,221,55,165,86,159,100,160,58,164,50,207,30,152,84,150,67,168,108,0,189,34,212,88,167,83,7,111,174,63,162,98,20,124,13,198,27,93,171,82,10,190,16,106,169,64,139,14,117,219,61,172,71,159,81,154,90,23,209,28,97,233,126,50,125,228,89,163,60,128,221,42,202,82,8,193,5,116,183,71,152,0,188,33,205,47,129,235,186,4,100,19,197,38,207,24,210,101,158,76,167,62,173,112,49,146,5,87,18,199,36,113,48,127,29,213,24,194,34,209,85,154,80,235,148,8,187,1,117,46,211,83,173,57,119,11,106,182,111,178,64,158,93,7,185,236,135,228,56,231,74,156,67,161,47,133,230,87,169,100,187,34,198,75,146,237,121,222,54,210,26,214,32,190,239,118,35,107,179,63,159,43,138,227,127,4,191,238,189,13,114,47,121,18,97,171,85,16,99,183,104,15,128,186,33,98,157,73,236,148,74,234,187,6,195,25,92,28,204,40,129,59,174,82,153,65,176,108,169,109,213,44,224,48,210,22,96,168,55,220,63,166,77,155,90,175,58,117,52,229,182,70,167,111,50,141,1,184,128,12,84,7,183,67,164,79,203,34,192,2,106,163,46,216,30,150,83,165,78,0,137,225,140,66,180,105,16,204,17,88,205,91,163,109,168,58,131,189,6,103,21,211,53,116,20,95,26,134,7,99,176,79,147,30,187,132,184,237,72,186,31,197,9,149,85,207,52,125,224,45,129,17,202,19,86,177,65,171,55,225,43,119,22,100,157,103,168,66,165,88,203,30,217,107,161,97,209,42,200,13,118,215,25,193,1,112,175,80,146,10,81,210,91,23,214,27,94,154,29,96,173,113,37,211,30,212,25,205,15,192,20,105,182,238,131,185,101,164,73,186,236,118,49,166,99,5,190,35,187,125,12,145,30,188,233,56,123,180,64,175,107,178,223,136,226,130,222,179,81,173,73,238,193,32,184,228,98,24,89,8,103,162,93,22,196,5,182,131,49,223,181,239,107,160,108,50,113,15,121,60,221,180,94,25,86,170,98,14,87,214,57,171,114,179,130,191,31,112,47,134,189,102,158,68,142,238,123,4,122,213,28,188,232,182,234,136,45,206,93,181,128,55,124,59,167,90,169,53,223,41,109,200,77,5,121,213,36,97,158,108,234,134,185,4,196,20,83,227,178,132,235,190,40,125,51,230,184,135,23,211,47,117,60,176,215,26,131,191,6,114,182,86,21,120,42,138,51,210,33,185,98,18,192,8,106,165,100,12,186,133,85,148,27,89,13,97,21,104,156,58,127,187,11,126,1,151,0,194,7,140,16,95,174,116,3,197,110,48,129,186,74,172,212,94,160,104,36,189,137,45,162,200,31,187,235,120,60,125,231,54,119,37,202,167,68,179,220,44,102,161,46,126,19,191,233,78,149,20,214,41,100,168,50,106,184,5,145,3,141,47,159,67,151,75,169,207,40,224,178,221,31,213,26,154,1,94,23,217,24,188,124,61,119,172,56,230,140,57,161,90,181,220,48,111,15,116,204,30,206,83,170,65,182,8,121,19,208,28,88,135,183,228,53,236,100,161,106,172,126,49,231,131,178,129,193,7,127,17,89,4,194,42,130,69,184,102,155,84,164,203,166,97,26,85,22,95,153,27,182,136,92,207,86,18,211,28,146,15,151,9,147,87,205,37,105,12,120,56,217,175,125,58,119,178,31,93,34,190,234,45,202,165,116,59,216,25,132,222,177,94,206,170,120,184,113,213,95,30,218,55,136,190,12,193,108,52,112,215,105,158,74,187,239,195,236,77,203,15,189,132,86,209,53,129,180,96,14,112,161,198,109,158,48,233,54,166,71,124,183,0,195,30,222,52,219,102,13,139,40,128,229,186,32,177,133,80,201,166,112,55,212,27,83,200,11,147,5,195,103,175,214,21,191,129,79,6,176,87,1,73,188,137,91,165,204,39,138,58,110,160,199,43,97,164,56,146,69,123,62,1,191,103,38,94,17,99,158,10,126,41,222,27,205,171,60,115,181,108,164,104,198,163,84,18,91,183,231,42,98,3,186,227,57,2,150,77,192,232,101,212,176,133,27,127,182,137,94,165,50,208,24,216,174,223,128,59,118,33,147,235,47,143,58,217,179,67,124,43,207,168,87,29,102,48,116,237,195,41,211,34,185,13,121,176,61,2,188,123,212,32,219,28,85,178,23,83,225,128,180,137,97,217,109,162,115,49,106,155,3,123,45,118,207,20,85,9,184,90,138,12,103,211,38,151,29,223,186,237,181,33,114,161,201,82,131,177,81,23,219,55,232,99,15,95,37,196,162,105,186,17,87,149,238,53,140,236,189,231,103,22,151,237,188,100,50,132,190,130,178,239,74,145,7,126,227,70,171,107,214,25,89,35,209,172,131,87,208,168,201,41,138,93,182,220,106,18,75,231,40,202,79,235,196,103,154,31,217,36,92,22,133,175,135,94,42,108,238,99,239,136,231,51,113,12,161,60,111,158,116,160,47,122,184,224,27,124,165,199,87,177,132,28,182,236,119,206,169,86,213,114,186,135,6,101,163,96,44,230,190,30,97,16,100,14,200,160,103,52,239,83,19,215,178,126,12,201,113,165,72,13,192,125,182,118,40,97,0,139,5,198,2,54,169,127,181,67,135,176,22,188,234,191,126,82,20,186,107,47,116,61,178,102,210,84,29,214,179,34,218,62,169,200,85,151,66,146,4,111,185,31,202,9,122,163,45,237,75,144,10,107,219,21,96,33,87,184,116,216,176,129,16,88,26,192,40,126,56,173,227,191,100,46,111,53,107,158,113,172,93,5,181,138,96,166,65,156,101,14,119,44,200,4,188,16,90,130,236,179,129,239,148,35,94,133,222,187,118,210,96,19,209,175,218,22,77,156,2,52,206,165,126,180,120,166,48,214,92,44,225,26,82,30,113,163,199,108,212,49,211,95,34,221,46,234,194,106,54,102,176,111,189,232,94,167,203,162,58,239,115,6,142,43,131,80,123,73,20,220,174,219,29,205,172,121,160,69,124,182,218,47,162,119,209,99,217,106,32,228,127,171,132,59,122,70,238,178,138,188,31,157,28,225,60,218,45,189,227,88,163,195,233,40,92,184,7,72,193,76,6,110,61,117,215,28,196,111,204,173,118,189,78,147,49,168,128,5,105,221,19,119,35,214,46,127,88,238,44,93,178,80,145,1,189,135,97,10,103,27,221,61,112,3,77,199,169,125,2,121,78,170,58,176,132,233,182,34,86,6,104,163,56,158,120,161,197,11,83,146,32,187,228,45,101,151,236,181,99,51,140,94,223,25,226,190,131,179,24,90,206,171,227,184,142,4,55,118,37,212,84,10,159,98,211,50,144,16,200,168,210,104,51,131,68,138,184,235,134,86,24,128,85,35,99,137,185,115,18,216,37,209,39,183,119,168,19,112,188,227,23,75,201,10,94,32,102,164,95,139,8,101,1,194,238,117,71,150,36,135,58,154,108,62,12,165,54,221,29,186,6,148,13,98,188,5,174,133,61,158,200,1,192,129,91,146,228,73,185,109,166,197,237,105,198,24,215,182,142,102,216,23,92,46,207,97,51,5,61,165,90,33,223,66,176,7,52,123,160,198,82,28,151,18,222,175,4,197,32,178,218,183,30,229,122,53,171,134,40,137,102,159,45,236,71,192,226,97,27,87,133,188,107,156,70,114,205,50,162,12,90,126,28,79,167,89,37,83,129,23,223,17,217,184,139,65,132,96,30,159,195,34,215,31,81,201,107,193,123,183,26,211,138,179,125,68,116,180,213,98,22,228,178,214,110,20,104,137,12,119,48,198,165,99,47,204,161,122,175,75,154,114,61,239,42,192,235,149,86,37,93,2,131,226,125,6,180,238,152,55,1,174,136,187,25,119,230,94,234,197,169,82,14,71,113,223,28,207,176,229,86,146,0,56,104,26,228,148,61,179,143,181,64,157,66,128,88,131,15,125,46,222,172,100,9,60,118,163,202,29,209,140,103,136,24,230,141,7,197,39,208,82,149,34,177,33,101,186,234,115,172,202,3,80,116,73,174,85,159,123,167,129,44,188,221,64,231,193,67,110,163,98,48,134,60,157,198,233,190,147,238,175,57,230,125,91,47,3,53,10,178,235,54,138,98,8,127,164,200,105,7,143,1,89,122,11,211,167,198,171,77,130,224,96,51,225,23,206,33,81,27,231,181,218,25,83,13,146,47,140,215,22,72,175,139,77,122,211,15,138,87,172,107,195,43,135,100,207,90,20,166,52,144,191,41,94,169,209,18,167,49,3,88,148,99,131,221,176,59,161,75,173,55,223,182,38,214,183,222,73,6,204,86,30,179,106,140,2,190,221,58,102,26,201,159,113,54,209,81,151,31,225,180,219,14,126,162,44,106,136,185,28,123,87,20,228,71,24,224,138,85,124,158,94,19,175,235,102,196,170,117,56,160,192,225,69,178,209,174,25,111,65,169,116,155,73,21,177,113,187,2,107,168,125,66,144,83,30,78,151,61,115,219,20,79,166,11,101,141,239,40,155,97,212,36,232,196,72,161,55,167,132,1,180,227,185,216,60,172,235,189,17,107,139,97,50,8,92,45,5,85,182,98,132,20,199,159,57,103,141,21,78,201,167,64,238,135,104,214,14,140,213,51,169,120,23,188,76,148,187,142,176,30,227,172,89,130,52,4,205,41,85,208,53,1,202,112,37,136,88,122,74,114,156,9,124,174,201,87,179,234,129,164,100,58,232,191,134,22,86,28,95,231,23,213,184,29,215,12,169,89,178,144,233,106,211,181,112,32,224,16,113,180,38,85,143,67,220,59,13,164,194,230,29,191,146,63,223,171,210,36,121,158,58,116,42,133,83,212,33,79,119,165,47,195,37,161,127,178,115,223,13,50,104,220,27,73,194,12,148,1,40,189,75,157,92,166,69,111,62,129,93,216,10,184,218,33,183,143,108,135,95,154,117,15,225,189,106,21,64,179,2,102,60,155,67,199,110,18,124,47,206,0,57,141,17,229,191,165,70,153,98,234,26,89,42,157,11]; 

        const TOTAL_NAILS = 240;
        const CANVAS_SIZE = 1000;
        const RADIUS = 350;
        const CX = 500;
        const CY = 500;

        const threadCanvas = document.getElementById('threadCanvas');
        const uiCanvas = document.getElementById('uiCanvas');
        const bgCanvas = document.getElementById('bgCanvas');
        const tCtx = threadCanvas.getContext('2d');
        const uiCtx = uiCanvas.getContext('2d');
        const bgCtx = bgCanvas.getContext('2d');

        let sequence = PATTERN_DATA;
        let currentIndex = 0;
        let isPlaying = false;
        let pins = [];

        [threadCanvas, uiCanvas, bgCanvas].forEach(c => {
            c.width = CANVAS_SIZE;
            c.height = CANVAS_SIZE;
        });

        function initNails() {
            pins = [];
            const step = 360 / TOTAL_NAILS;
            const zoneMapping = ['B', 'A', 'D', 'C'];
            
            for (let i = 0; i < TOTAL_NAILS; i++) {
                const angleDeg = (i * step) - 180 + (step / 2);
                const angleRad = ((angleDeg * Math.PI) / 180) + Math.PI; 
                const quadIndex = Math.floor(i / 60);
                const zone = zoneMapping[quadIndex];

                pins.push({
                    x: CX + RADIUS * Math.cos(angleRad),
                    y: CY + RADIUS * Math.sin(angleRad),
                    angleRad: angleRad,
                    zone: zone,
                    nailNum: (i % 60) + 1
                });
            }
        }

        function drawBackground() {
            bgCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            bgCtx.fillStyle = "black";
            bgCtx.fillRect(500, 500, 500, 500); 
            bgCtx.fillRect(0, 0, 500, 500); 

            bgCtx.beginPath();
            bgCtx.arc(CX, CY, RADIUS, 0, Math.PI * 2);
            bgCtx.fillStyle = "white";
            bgCtx.fill();
            bgCtx.strokeStyle = "black";
            bgCtx.lineWidth = 1;
            bgCtx.stroke();

            bgCtx.font = "bold 60px Arial";
            bgCtx.textAlign = "center";
            bgCtx.textBaseline = "middle";
            
            bgCtx.fillStyle = "#333";
            bgCtx.fillText("A", 80, 920); 
            bgCtx.fillText("C", 920, 80); 
            bgCtx.fillStyle = "white";
            bgCtx.fillText("B", 920, 920); 
            bgCtx.fillText("D", 80, 80);   

            pins.forEach((p, i) => {
                bgCtx.beginPath();
                bgCtx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
                bgCtx.fillStyle = "black";
                bgCtx.fill();

                const offset = (i % 2 === 0) ? 32 : 54;
                const lx = CX + (RADIUS + (offset - 10)) * Math.cos(p.angleRad);
                const ly = CY + (RADIUS + (offset - 10)) * Math.sin(p.angleRad);
                const tx = CX + (RADIUS + offset) * Math.cos(p.angleRad);
                const ty = CY + (RADIUS + offset) * Math.sin(p.angleRad);

                const isOverBlack = (tx < 500 && ty < 500) || (tx > 500 && ty > 500);

                bgCtx.beginPath();
                bgCtx.moveTo(p.x, p.y);
                bgCtx.lineTo(lx, ly);
                bgCtx.strokeStyle = isOverBlack ? "white" : "black"; 
                bgCtx.lineWidth = 0.5;
                bgCtx.stroke();

                bgCtx.font = "bold 10px Arial";
                bgCtx.fillStyle = isOverBlack ? "white" : "black";
                bgCtx.fillText(p.nailNum, tx, ty);
            });
        }

        const getMappedPin = (val) => {
            if (val === undefined || val === null) return null;
            return pins[parseInt(val) % TOTAL_NAILS];
        };

        function updateDisplay() {
            if (!sequence || sequence.length === 0) {
                document.getElementById('stepLabel').innerText = "No Data";
                return;
            }

            const pCur = getMappedPin(sequence[currentIndex]);
            const pNext = (currentIndex < sequence.length - 1) ? getMappedPin(sequence[currentIndex + 1]) : null;

            document.getElementById('stepLabel').innerText = `${currentIndex} / ${sequence.length - 1}`;
            document.getElementById('percentLabel').innerText = Math.round((currentIndex / (sequence.length - 1)) * 100) + '%';
            
            document.getElementById('curNailBox').innerText = pCur ? pCur.nailNum : '--';
            document.getElementById('curZoneLabel').innerText = pCur ? `Zone ${pCur.zone}` : 'From';
            
            if (pNext) {
                document.getElementById('nextNailBox').innerText = pNext.nailNum;
                document.getElementById('nextZoneLabel').innerText = `Zone ${pNext.zone}`;
            } else {
                document.getElementById('nextNailBox').innerText = '--';
                document.getElementById('nextZoneLabel').innerText = 'End';
            }

            drawThreads();
            drawOverlay(pCur, pNext);

            if (document.getElementById('voiceToggle').checked && !isPlaying && pNext) {
                speakNail(pNext.zone, pNext.nailNum);
            }
        }

        function drawThreads() {
            tCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            if (sequence.length < 2) return;

            tCtx.strokeStyle = 'rgba(0, 0, 0, 0.45)'; 
            tCtx.lineWidth = 0.35;
            tCtx.beginPath();

            for (let i = 0; i < currentIndex; i++) {
                const p1 = getMappedPin(sequence[i]);
                const p2 = getMappedPin(sequence[i + 1]);
                if (p1 && p2) {
                    tCtx.moveTo(p1.x, p1.y);
                    tCtx.lineTo(p2.x, p2.y);
                }
            }
            tCtx.stroke();
        }

        function drawOverlay(pCur, pNext) {
            uiCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            if (!pCur) return;

            // Highlight current nail
            uiCtx.beginPath();
            uiCtx.arc(pCur.x, pCur.y, 9, 0, Math.PI * 2);
            uiCtx.fillStyle = 'rgba(59, 130, 246, 0.8)';
            uiCtx.fill();

            if (pNext) {
                // Directional line
                uiCtx.beginPath();
                uiCtx.setLineDash([8, 6]);
                uiCtx.moveTo(pCur.x, pCur.y);
                uiCtx.lineTo(pNext.x, pNext.y);
                uiCtx.strokeStyle = '#ef4444';
                uiCtx.lineWidth = 5;
                uiCtx.stroke();
                uiCtx.setLineDash([]);
                
                // Highlight target nail
                uiCtx.beginPath();
                uiCtx.arc(pNext.x, pNext.y, 14, 0, Math.PI * 2);
                uiCtx.strokeStyle = '#3b82f6';
                uiCtx.lineWidth = 6;
                uiCtx.stroke();

                // Small center dot for precision
                uiCtx.beginPath();
                uiCtx.arc(pNext.x, pNext.y, 3, 0, Math.PI * 2);
                uiCtx.fillStyle = '#ef4444';
                uiCtx.fill();
            }
        }

        function speakNail(zone, num) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(`${zone}... ${num}`);
            msg.rate = 0.95; 
            msg.pitch = 1.1;
            window.speechSynthesis.speak(msg);
        }

        document.getElementById('nextBtn').onclick = () => { if (currentIndex < sequence.length - 1) { currentIndex++; updateDisplay(); } };
        document.getElementById('prevBtn').onclick = () => { if (currentIndex > 0) { currentIndex--; updateDisplay(); } };
        
        document.getElementById('playBtn').onclick = () => {
            if (isPlaying) { 
                isPlaying = false; 
                document.getElementById('playBtn').innerText = "‚ñ∂ Play Sequence"; 
                document.getElementById('playBtn').classList.replace('bg-orange-600', 'bg-blue-600');
            }
            else { 
                isPlaying = true; 
                document.getElementById('playBtn').innerText = "‚è∏ Pause Auto"; 
                document.getElementById('playBtn').classList.replace('bg-blue-600', 'bg-orange-600');
                autoPlay(); 
            }
        };

        function autoPlay() {
            if (!isPlaying || currentIndex >= sequence.length - 1) {
                isPlaying = false;
                document.getElementById('playBtn').innerText = "‚ñ∂ Play Sequence";
                document.getElementById('playBtn').classList.replace('bg-orange-600', 'bg-blue-600');
                return;
            }
            currentIndex++;
            updateDisplay();
            setTimeout(autoPlay, 250); // Balanced speed for visual tracking
        }

        document.getElementById('jumpBtn').onclick = () => {
            const val = parseInt(document.getElementById('jumpInput').value);
            if (!isNaN(val) && val >= 0 && val < sequence.length) { currentIndex = val; updateDisplay(); }
        };
        
        document.getElementById('previewBtn').onclick = () => { 
            currentIndex = sequence.length - 1; 
            updateDisplay(); 
        };

        window.onload = () => {
            initNails();
            drawBackground();
            updateDisplay();
        };
    </script>
</body>
</html>
