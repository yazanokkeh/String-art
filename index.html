<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>String Art Virtual Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        
        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .board-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            aspect-ratio: 1/1;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .control-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px; /* Touch target size */
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.2);
        }

        .control-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-4 md:py-8 px-4">

    <!-- Header & Stats -->
    <div class="w-full max-w-7xl flex flex-col md:flex-row justify-between items-center gap-4 md:gap-6 mb-6 md:mb-8">
        <div class="text-center md:text-left">
            <h1 class="text-3xl md:text-4xl font-bold tracking-tighter uppercase leading-none text-white">
                Thread and Nails
            </h1>
        </div>

        <div class="flex w-full md:w-auto gap-2 md:gap-4 glass-panel p-3 md:p-4 rounded-2xl justify-around md:justify-start">
            <div class="text-center px-4 border-r border-slate-700">
                <p class="text-[10px] md:text-xs text-slate-500 uppercase">Progress</p>
                <p id="percentLabel" class="text-lg md:text-xl font-bold">0%</p>
            </div>
            <div class="text-center px-4">
                <p class="text-[10px] md:text-xs text-slate-500 uppercase">Step</p>
                <p id="stepLabel" class="text-lg md:text-xl font-bold">0 / 0</p>
            </div>
        </div>
    </div>

    <div class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8 items-start">
        
        <!-- Canvas (Top on mobile) -->
        <div class="lg:col-span-8 flex justify-center order-1 lg:order-2">
            <div class="board-container">
                <canvas id="bgCanvas"></canvas>
                <canvas id="threadCanvas"></canvas>
                <canvas id="uiCanvas"></canvas>
            </div>
        </div>

        <!-- Controls -->
        <div class="lg:col-span-4 space-y-4 order-2 lg:order-1 no-select">
            <div class="glass-panel p-4 md:p-6 rounded-3xl space-y-4 md:space-y-5">
                <div class="grid grid-cols-2 gap-3">
                    <button id="prevBtn" class="control-btn py-3 px-4 bg-slate-700 rounded-xl font-bold text-sm">‚Üê Prev</button>
                    <button id="nextBtn" class="control-btn py-3 px-4 bg-slate-700 rounded-xl font-bold text-sm">Next ‚Üí</button>
                    <button id="playBtn" class="control-btn py-3 px-4 bg-blue-600 rounded-xl font-bold text-sm col-span-2">‚ñ∂ Play Sequence</button>
                    <button id="previewBtn" class="control-btn py-3 px-4 bg-emerald-600 rounded-xl font-bold text-sm col-span-2">üëÅ Show Result</button>
                </div>

                <div class="flex items-center gap-2">
                    <input type="number" id="jumpInput" placeholder="Jump to..." class="flex-1 bg-slate-900 border border-slate-700 rounded-xl py-2 px-4 text-sm focus:outline-none focus:border-blue-500 min-h-[44px]">
                    <button id="jumpBtn" class="bg-slate-700 hover:bg-slate-600 h-[44px] px-4 rounded-xl text-sm font-bold">Go</button>
                </div>

                <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl">
                    <span class="text-sm font-medium text-slate-300">Voice Guidance</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="voiceToggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <!-- Current Instruction Card -->
            <div class="glass-panel p-4 md:p-6 rounded-3xl text-center">
                <p class="text-[10px] md:text-xs text-slate-500 uppercase mb-3 md:mb-4">Current Instruction</p>
                <div class="flex items-center justify-center gap-4 md:gap-6">
                    <div>
                        <span id="curNailBox" class="text-3xl md:text-4xl font-bold text-slate-300">--</span>
                        <p class="text-[9px] md:text-[10px] mt-1 text-slate-500 uppercase" id="curZoneLabel">From</p>
                    </div>
                    <div class="text-blue-500 text-xl md:text-2xl animate-pulse">‚Üí</div>
                    <div>
                        <span id="nextNailBox" class="text-3xl md:text-4xl font-bold text-blue-400">--</span>
                        <p class="text-[9px] md:text-[10px] mt-1 text-slate-500 uppercase" id="nextZoneLabel">To</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="patternLoader" src="pattern.js"></script>

    <script>
        const TOTAL_NAILS = 240;
        const CANVAS_SIZE = 1000;
        const RADIUS = 350;
        const CX = 500;
        const CY = 500;

        const threadCanvas = document.getElementById('threadCanvas');
        const uiCanvas = document.getElementById('uiCanvas');
        const bgCanvas = document.getElementById('bgCanvas');
        const tCtx = threadCanvas.getContext('2d');
        const uiCtx = uiCanvas.getContext('2d');
        const bgCtx = bgCanvas.getContext('2d');

        let sequence = [];
        let currentIndex = 0;
        let isPlaying = false;
        let pins = [];

        [threadCanvas, uiCanvas, bgCanvas].forEach(c => {
            c.width = CANVAS_SIZE;
            c.height = CANVAS_SIZE;
        });

        function initNails() {
            pins = [];
            const step = 360 / TOTAL_NAILS;
            const zoneMapping = ['B', 'A', 'D', 'C'];
            
            for (let i = 0; i < TOTAL_NAILS; i++) {
                const angleDeg = (i * step) - 180 + (step / 2);
                const angleRad = ((angleDeg * Math.PI) / 180) + Math.PI; 
                const quadIndex = Math.floor(i / 60);
                const zone = zoneMapping[quadIndex];

                pins.push({
                    x: CX + RADIUS * Math.cos(angleRad),
                    y: CY + RADIUS * Math.sin(angleRad),
                    angleRad: angleRad,
                    zone: zone,
                    nailNum: (i % 60) + 1
                });
            }
        }

        function drawBackground() {
            bgCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            bgCtx.fillStyle = "black";
            bgCtx.fillRect(500, 500, 500, 500); 
            bgCtx.fillRect(0, 0, 500, 500); 

            bgCtx.beginPath();
            bgCtx.arc(CX, CY, RADIUS, 0, Math.PI * 2);
            bgCtx.fillStyle = "white";
            bgCtx.fill();
            bgCtx.strokeStyle = "black";
            bgCtx.lineWidth = 1;
            bgCtx.stroke();

            bgCtx.font = "bold 60px Arial";
            bgCtx.textAlign = "center";
            bgCtx.textBaseline = "middle";
            
            bgCtx.fillStyle = "#333";
            bgCtx.fillText("A", 80, 920); 
            bgCtx.fillText("C", 920, 80); 
            bgCtx.fillStyle = "white";
            bgCtx.fillText("B", 920, 920); 
            bgCtx.fillText("D", 80, 80);   

            pins.forEach((p, i) => {
                bgCtx.beginPath();
                bgCtx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
                bgCtx.fillStyle = "black";
                bgCtx.fill();

                const offset = (i % 2 === 0) ? 32 : 54;
                const lx = CX + (RADIUS + (offset - 10)) * Math.cos(p.angleRad);
                const ly = CY + (RADIUS + (offset - 10)) * Math.sin(p.angleRad);
                const tx = CX + (RADIUS + offset) * Math.cos(p.angleRad);
                const ty = CY + (RADIUS + offset) * Math.sin(p.angleRad);

                const isOverBlack = (tx < 500 && ty < 500) || (tx > 500 && ty > 500);

                bgCtx.beginPath();
                bgCtx.moveTo(p.x, p.y);
                bgCtx.lineTo(lx, ly);
                bgCtx.strokeStyle = isOverBlack ? "white" : "black"; 
                bgCtx.lineWidth = 0.5;
                bgCtx.stroke();

                bgCtx.font = "bold 10px Arial";
                bgCtx.fillStyle = isOverBlack ? "white" : "black";
                bgCtx.fillText(p.nailNum, tx, ty);
            });
        }

        const getMappedPin = (val) => {
            if (val === undefined || val === null) return null;
            return pins[parseInt(val) % TOTAL_NAILS];
        };

        function updateDisplay() {
            if (!sequence || sequence.length === 0) return;

            const pCur = getMappedPin(sequence[currentIndex]);
            const pNext = (currentIndex < sequence.length - 1) ? getMappedPin(sequence[currentIndex + 1]) : null;

            document.getElementById('stepLabel').innerText = `${currentIndex} / ${sequence.length - 1}`;
            document.getElementById('percentLabel').innerText = Math.round((currentIndex / (sequence.length - 1)) * 100) + '%';
            
            document.getElementById('curNailBox').innerText = pCur ? pCur.nailNum : '--';
            document.getElementById('curZoneLabel').innerText = pCur ? `Zone ${pCur.zone}` : 'From';
            
            if (pNext) {
                document.getElementById('nextNailBox').innerText = pNext.nailNum;
                document.getElementById('nextZoneLabel').innerText = `Zone ${pNext.zone}`;
            } else {
                document.getElementById('nextNailBox').innerText = '--';
                document.getElementById('nextZoneLabel').innerText = 'End';
            }

            drawThreads();
            drawOverlay(pCur, pNext);

            if (document.getElementById('voiceToggle').checked && !isPlaying && pNext) {
                speakNail(pNext.zone, pNext.nailNum);
            }
        }

        function drawThreads() {
            tCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            if (sequence.length < 2) return;

            tCtx.strokeStyle = 'rgba(0, 0, 0, 0.35)';
            tCtx.lineWidth = 0.4;
            tCtx.beginPath();

            for (let i = 0; i < currentIndex; i++) {
                const p1 = getMappedPin(sequence[i]);
                const p2 = getMappedPin(sequence[i + 1]);
                if (p1 && p2) {
                    tCtx.moveTo(p1.x, p1.y);
                    tCtx.lineTo(p2.x, p2.y);
                }
            }
            tCtx.stroke();
        }

        function drawOverlay(pCur, pNext) {
            uiCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            if (!pCur) return;

            uiCtx.beginPath();
            uiCtx.arc(pCur.x, pCur.y, 9, 0, Math.PI * 2);
            uiCtx.fillStyle = 'rgba(59, 130, 246, 0.7)';
            uiCtx.fill();

            if (pNext) {
                uiCtx.beginPath();
                uiCtx.setLineDash([6, 4]);
                uiCtx.moveTo(pCur.x, pCur.y);
                uiCtx.lineTo(pNext.x, pNext.y);
                uiCtx.strokeStyle = '#ef4444';
                uiCtx.lineWidth = 2.5;
                uiCtx.stroke();
                uiCtx.setLineDash([]);
                
                uiCtx.beginPath();
                uiCtx.arc(pNext.x, pNext.y, 11, 0, Math.PI * 2);
                uiCtx.strokeStyle = '#3b82f6';
                uiCtx.lineWidth = 3.5;
                uiCtx.stroke();
            }
        }

        function speakNail(zone, num) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(`Zone ${zone}, Nail ${num}`);
            msg.rate = 1.3;
            window.speechSynthesis.speak(msg);
        }

        document.getElementById('nextBtn').onclick = () => { if (currentIndex < sequence.length - 1) { currentIndex++; updateDisplay(); } };
        document.getElementById('prevBtn').onclick = () => { if (currentIndex > 0) { currentIndex--; updateDisplay(); } };
        document.getElementById('playBtn').onclick = () => {
            if (isPlaying) { isPlaying = false; document.getElementById('playBtn').innerText = "‚ñ∂ Play Sequence"; }
            else { isPlaying = true; document.getElementById('playBtn').innerText = "‚è∏ Pause"; autoPlay(); }
        };
        function autoPlay() {
            if (!isPlaying || currentIndex >= sequence.length - 1) {
                isPlaying = false;
                document.getElementById('playBtn').innerText = "‚ñ∂ Play Sequence";
                return;
            }
            currentIndex++;
            updateDisplay();
            setTimeout(autoPlay, 120);
        }
        document.getElementById('jumpBtn').onclick = () => {
            const val = parseInt(document.getElementById('jumpInput').value);
            if (!isNaN(val) && val >= 0 && val < sequence.length) { currentIndex = val; updateDisplay(); }
        };
        document.getElementById('previewBtn').onclick = () => { currentIndex = sequence.length - 1; updateDisplay(); };

        window.onload = () => {
            initNails();
            drawBackground();

            if (typeof PATTERN_DATA !== 'undefined' && PATTERN_DATA.length > 0) {
                sequence = PATTERN_DATA;
                updateDisplay();
            }
        };
    </script>
</body>
</html>
